---
title: 在家中部署智慧家庭系统
date: 2019-07-28
categories:
- tech
tags:
- iot
- smart-home
- LoRa
- WiFi
- Arduino
- ESP8266
- MQTT
---
基于Home Assisstant搭建综合家庭照明系统，多媒体系统，水流系统的智慧家庭。技术点：天猫精灵交互，LoRa通信，MQTT协议，frp内网穿透，NAS存储，拨动开关电路改造。


<!--more-->

结合所学知识，运用前沿技术，造福生活，是我长期以来的不懈追求。为了让家人体验到更加稳定、舒适智能的生活方式，同时也为了巩固憨实先前在学校smartfarm项目和我自己的ushio系统中所积累的技术基础以及架构经验，我决定在出国前，使用20到23整天时间，重构家中老旧的物联网系统。采用分层架构和面向接口、面向测试、**面向文档**开发原则，以**稳定性(Available)**，**可靠性(Reliable)**为最优先指标，搭建一个运行目标3年以上的高度模块化的，易于远程操控的，开源的家庭软件硬件智能传感控制系统。

## 0 架构综述


## 1 硬件设计

### 1.1 单片机选材
使用Arduino UNO作为计算单元。一方面，Arduino Uno拥有高可靠性，我之前的智慧窗帘系统使用Arduino Uno作为主控板，平稳运行1年半未出现硬件问题。另一方面，Arduino Uno拥有较大的RAM，无需为了争夺RAM而在单片机编程上煞费苦心。

Arduino UNO的缺陷主要是价格高，但是为保障长期稳定运行，这个成本是必要的。

### 1.2 WiFi通信模块选材

使用ESP-01作为WiFi的通信模块。主要原因是之前学校课程使用过ESP-01搭建遥控小车，对其工作方式和性能比较了解，降低开发成本。

### 1.3 LoRa通信模块选材

使用**安信可 LORA RA-02 LORA**作为LoRa节点和LoRa网关通信模块。原因是surf项目使用的就是这个模块，比较了解它。

### 1.4 智能音箱选材

智能音箱作为此物联网系统人机交互的最主要界面，发挥着举足轻重的作用。经研究，我使用天猫精灵方糖R作为家用智能音箱。一方面，天猫精灵的性价比摆在那里，非常便宜。第二，与小米开发小爱同学不同，阿里开发天猫精灵的目的是提供平台，它允许开发者以各种形式接入其网络，这一点对我至关重要。

### 1.5 灯拨动开关

初期设想: 单向控制+复位器。
实际实现：将原有单开改造为双开，一路与继电器串联，另一路与两个pin口相连。


## 2 通信设计

![网络拓扑图](https://api.yimian.xyz/img/?path=imgbed/img_43b85bd4_1096x660_8_null_normal.png)

采用WiFi+LoRa两种通信模式。在需要高速高质量通信的场景，如天猫精灵，手机，笔记本，使用WiFi作为通信手段。在WiFi信号不稳定的地方，使用LoRa进行通信。使用MQTT为应用层协议。

## 3 主控系统设计

使用python3开源项目Home Assistant 为基础搭建本项目的主控系统。

## 4 多媒体系统设计

多媒体主要由天猫精灵提供。此外，通过小米盒子，家庭网盘中的视频，图片，音乐实现了电视与音响上的播放。

## 5 云端支持系统设计

dns.yimian.xyz提供dns解析服务。

## 6 NAS存储系统设计

通过挂载从老电脑上拆卸的闲置500G机械硬盘到老IBM服务器，实现存储系统的搭建。
对局域网内，由于家里都是win系统，使用smb作为共享协议实现文件传输，支持局域网内挂载。速度稳定，全网读写10MB/s左右。对外网访问，通过http，frp反代实现，但速度较慢。

------------------------
2020.6 更新

## RNN实现对灯控制

基于先前积累的人体传感器数据，通过LSTM模型，使用keras训练神经网络，实现对开灯状态的预测。